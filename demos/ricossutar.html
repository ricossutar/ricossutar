<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8">
  <title>RiccoSSUtar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
  <link rel="shortcut icon" href="/demos/logo.png">
  <link rel="stylesheet" href="/demos/room_style.css">
  <!-- <link rel="stylesheet" href="/demos/stylesheet.css"> -->
  <script src="/demos/menu.js"></script>
</head>
<body>
    <div class="nav">
        <a style='width:fit-content; height:fit-content;' href="/">
            <img class='logo'src="/demos/logo.png"/>
        </a>
    </div> 
    <div class="main_container">
        <div class='flex_container' id="main_room">
            <div class='left_box'>
                <div class='room_container'>
                    <div class='room_button' id="ricossu1">
                        1번방
                    </div>
                    <div class='room_button' id="ricossu2">
                        2번방
                    </div>
                    <div class='room_button' id="ricossu3">
                        3번방
                    </div>
                    <div class='room_button' id="ricossu4">
                        4번방
                    </div>
                    <div class='room_button' id="ricossu5">
                        5번방
                    </div>
                    <div class='room_button' id="ricossu6">
                        6번방
                    </div>
                    <div class='room_button' id="ricossu7">
                        7번방
                    </div>
                    <div class='room_button' id="ricossu8">
                        8번방
                    </div>
					<div class='room_button' id="ricossu9">
                        9번방
                    </div>
					<div class='room_button' id="ricossu10">
                        10번방
                    </div>
					<div class='room_button' id="ricossu11">
                        11번방
                    </div>
					<div class='room_button' id="ricossu12">
                        12번방
                    </div>
                </div>
            </div>
            <div class='right_box'>
                <img class='coin_logo'src="/demos/coin_logo_thin.png"/>
                <div id="not_logged">
                    <div id="login_view">
                        <label for="email">email</label>
                        <input type="text" id="login_email" name="email" required size="10">
                        <label for="password">비밀번호</label>
                        <input type="password" id="login_password" name="password" required size="10">
                        <a>
                            <button id='login_button'>입장하기</button>
                            <button class='change_attr'>회원가입 창으로</button>
                        </a>
                    </div>

                    <div id="register_view", style="display:none">
                        <label for="email">email</label>
                        <input type="text" id="register_email" name="email" required size="10">
                        <label for="name">이름</label>
                        <input type="text" id="register_name" name="name" required size="10">
                        <label for="password">비밀번호</label>
                        <input type="password" id="register_password" name="password" required size="10">
                        <a>
                            <button id='register_button'>확인</button>
                            <button class='change_attr'>로그인 창으로</button>
                        </a>
                    </div>                    
                </div>
                <div id="logged" style="display:none">
                    <div class='username_div'>
                        username_here
                    </div>
                </div>
                
            </div>
        </div>
        <div class='flex_container' id='karaoke_room' style="display:none">
            <div class='left_box'>
                <div id="videos-container" style="margin: 20px 0;"></div>
            </div>
            <div class='right_box' id='room-nav'>
                <img class='coin_logo'src="/demos/coin_logo_thin.png"/>
                <div id='num_container'>
                    번방
                </div>
                <div class='username_div'>
                    username_here
                </div>
                <div>예약목록</div>
                <div id='line'></div>
                <div id="conversation-panel">
                </div>
                <div style="width: 100%; display: flex;">
                    <textarea id="txt-chat-message" placeholder="예약곡을 입력해주세요" onkeypress="onTestChange();"></textarea>
                    <button class="btn btn-primary" id="btn-chat-message" style="width: 50px;">예약</button>
                </div>            
                    <div style="display: none;">
                        <button id='delete'><b>X</b></button><br>
                        <input type="text" id="room-id" value="abcdef" autocorrect=off autocapitalize=off size=20>
                        <button id="open-room">Open Room</button>
                        <button id="join-room">Join Room</button>
                        <button id="open-or-join-room">Auto Open Or Join Room</button> 
                    </div>
                <a href="/">
                    <button id='enter1'>나가기</button>
                </a>
            </div>
        </div>
    </div>

    <div class="footer">
        <br/>
        ⓒ 2021. ricossutar all rights reserved.<br/>
        Soongsil Univ.<br/>
        Project Team Ricossutar 안종훈 이종근 최다인
        <div id="room-urls" style="text-align: center;display: none;background: #F1EDED;margin: 15px -10px;border: 1px solid rgb(189, 189, 189);border-left: 0;border-right: 0;"></div>
  <br><br>
  <label     style="display: none;"><input type="checkbox" id="record-entire-conference"> Record Entire Conference In The Browser?</label>
  <span id="recording-status" style="display: none;"></span>
  <button id="btn-stop-recording" style="display: none;">Stop Recording</button>
        
    </div>
    
<script src="/dist/RTCMultiConnection.min.js"></script>
<script src="/node_modules/webrtc-adapter/out/adapter.js"></script>
<script src="/socket.io/socket.io.js"></script>

<!-- custom layout for HTML5 audio/video elements -->
<link rel="stylesheet" href="/dev/getHTMLMediaElement.css">
<script src="/dev/getHTMLMediaElement.js"></script>

<script src="/node_modules/recordrtc/RecordRTC.js"></script>
<script>

// ......................................................
// .......................UI Code........................
// ......................................................
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

    
var is_register = false;
var is_logged_in = false;
var my_name = '';
var change_arr = document.getElementsByClassName("change_attr");

for (var i=0; i < change_arr.length; i++) {
    change_arr[i].onclick = function() {
        if(is_register == false){
            is_register = true;
            document.getElementById("login_view").style.display = "none"; 
            document.getElementById("register_view").style.display = "block";
        }
        else{
            is_register = false;
            document.getElementById("login_view").style.display = "block";        
            document.getElementById("register_view").style.display = "none"; 
        }
    }
}
    
login_button.onclick = function(){
    var csrftoken = getCookie('csrftoken');
    fetch('https://rico-db.run.goorm.io/login/', {
        method: 'post',
         body: new URLSearchParams({
                csrftoken: csrftoken,
                email: document.getElementById("login_email").value,
                 password:document.getElementById("login_password").value
                })
            }).then((response) => response.json()).then((data) => {
        if(data.id == null)
            alert('잘못된 정보입니다. 다시 시도해주세요')
        else{
            is_logged_in = true;
            console.log(data)
            my_name = data.name;
            document.getElementById("not_logged").style.display = "none"; 
            document.getElementById("logged").style.display = "block"; 
            var username_arr = document.getElementsByClassName("username_div");
            for (var i=0; i < username_arr.length; i++) {
                username_arr[i].innerText = my_name + "님 환영합니다!"; 
            }
        }
    });
}

register_button.onclick = function(){
    var csrftoken = getCookie('csrftoken');
    fetch('https://rico-db.run.goorm.io/register/', {
         method: 'post',
         body: new URLSearchParams({
                     csrftoken:csrftoken, 
                     email:document.getElementById("register_email").value, 
                     name:document.getElementById("register_name").value,  
                     password:document.getElementById("register_password").value
               })
            }).then((response) => response.json()).then((data) => {
        if(data.id == null)
            alert('잘못된 형식 혹은 이미 존재하는 아이디입니다. 다시 시도해주세요')
        else{
            is_logged_in = true;
            console.log(data)
            my_name = data.name; 
            document.getElementById("not_logged").style.display = "none"; 
            document.getElementById("logged").style.display = "block"; 
            var username_arr = document.getElementsByClassName("username_div");
            for (var i=0; i < username_arr.length; i++) {
                username_arr[i].innerText = my_name + "님 환영합니다!"; 
            }
        }
    });
}


function sendPost(action, params) {
	var form = document.createElement('form');
	form.setAttribute('method', 'post');
	form.setAttribute('action', action);
	document.charset = "utf-8";
	for ( var key in params) {
		var hiddenField = document.createElement('input');
		hiddenField.setAttribute('type', 'hidden');
		hiddenField.setAttribute('name', key);
		hiddenField.setAttribute('value', params[key]);
		form.appendChild(hiddenField);
	}
	document.body.appendChild(form);
	form.submit(function(event){
        console.log(event);
    });
}

var photo = document.getElementsByClassName("room_button");
var cur_room_num = 0;

for (var i=0; i < photo.length; i++) {
    photo[i].onclick = function() {
        if(is_logged_in == false)
            {
                alert('로그인 후 이용해주세요');
                return;
            }
    document.getElementById("main_room").style.display = "none"; 
    document.getElementById("karaoke_room").style.display = "flex";

    disableInputButtons();
    connection.checkPresence(event.target.id, function(isRoomExist, roomid) {
        if (isRoomExist === true) {
            disableInputButtons();
            connection.join(roomid, function(isJoinedRoom, roomid, error) {
              if (error) {
                    disableInputButtons(true);
                    if(error === 'Room not available') {
                      alert('This room does not exist. Please either create it or wait for moderator to enter in the room.');
                      return;
                    }
                    alert(error);
                }
            });
            
        } else {

            disableInputButtons();
            connection.session.video = false;
            connection.session.screen = true;
            connection.open(roomid, function(isRoomOpened, roomid, error) {
                if(isRoomOpened === true) {
                  showRoomURL(connection.sessionid);
                }
                else {
                  disableInputButtons(true);
                  if(error === 'Room not available') {
                    alert('Someone already created this room. Please either join or create a separate room.');
                    return;
                  }
                  alert(error);
                }
            });
        }
    });        
    cur_room_num = parseInt(event.target.id.substr(7));
    document.getElementById("num_container").innerText = cur_room_num + "번방" ;
    }
};
    
document.getElementById('open-room').onclick = function() {
    disableInputButtons();
    connection.session.video = false;
    connection.session.screen = true;
    connection.open(document.getElementById('room-id').value, function(isRoomOpened, roomid, error) {
        if(isRoomOpened === true) {
          showRoomURL(connection.sessionid);
        }
        else {
          disableInputButtons(true);
          if(error === 'Room not available') {
            alert('Someone already created this room. Please either join or create a separate room.');
            return;
          }
          alert(error);
        }
    });
};

document.getElementById('join-room').onclick = function() {
    disableInputButtons();
    connection.join(document.getElementById('room-id').value, function(isJoinedRoom, roomid, error) {
      if (error) {
            disableInputButtons(true);
            if(error === 'Room not available') {
              alert('This room does not exist. Please either create it or wait for moderator to enter in the room.');
              return;
            }
            alert(error);
        }
    });
};

document.getElementById('open-or-join-room').onclick = function() {
    disableInputButtons();
    connection.openOrJoin(document.getElementById('room-id').value, function(isRoomExist, roomid, error) {
        if(error) {
          disableInputButtons(true);
          alert(error);
        }
        else if (connection.isInitiator === true) {
            // if room doesn't exist, it means that current user will create the room
            showRoomURL(roomid);
        }
    });
};
    
function appendChatMessage(received_message) {
    var div = document.createElement('div');
    var conversationPanel = document.getElementById('conversation-panel');
    div.className = 'message';
    div.innerHTML = received_message;
    conversationPanel.appendChild(div);
    conversationPanel.scrollTop = conversationPanel.clientHeight;
    conversationPanel.scrollTop = conversationPanel.scrollHeight - conversationPanel.scrollTop;
}
    
document.getElementById('btn-chat-message').onclick = function() {
    var chatMessage = document.getElementById("txt-chat-message").value
    chatMessage = my_name + " : " + chatMessage
    appendChatMessage(chatMessage);
    connection.send({
        chatMessage: chatMessage,
    });
    document.getElementById("txt-chat-message").value = "";
};

function onTestChange() {
    var key = window.event.keyCode;

    // If the user has pressed enter
    if (key === 13) {
        var chatMessage = document.getElementById("txt-chat-message").value
        chatMessage = my_name + " : " + chatMessage
        appendChatMessage(chatMessage);
        chatMessage = my_name + chatMessage
        connection.send({
            chatMessage: chatMessage,
        });
        document.getElementById("txt-chat-message").value = "";
    }
}    
// ......................................................
// ..................RTCMultiConnection Code.............
// ......................................................

var connection = new RTCMultiConnection();

connection.session = {
    audio: true,
    video: true,
    data: true
};


// by default, socket.io server is assumed to be deployed on your own URL
connection.socketURL = '/';

// comment-out below line if you do not have your own socket.io server
// connection.socketURL = 'https://rtcmulticonnection.herokuapp.com:443/';

connection.socketMessageEvent = 'video-conference-demo';

connection.sdpConstraints.mandatory = {
    OfferToReceiveAudio: true,
    OfferToReceiveVideo: true
};

// STAR_FIX_VIDEO_AUTO_PAUSE_ISSUES
// via: https://github.com/muaz-khan/RTCMultiConnection/issues/778#issuecomment-524853468
var bitrates = 512;
var resolutions = 'Ultra-HD';
var videoConstraints = {};

if (resolutions == 'HD') {
    videoConstraints = {
        width: {
            ideal: 1280
        },
        height: {
            ideal: 720
        },
        frameRate: 30
    };
}

if (resolutions == 'Ultra-HD') {
    videoConstraints = {
        width: {
            ideal: 1920
        },
        height: {
            ideal: 1080
        },
        frameRate: 30
    };
}

connection.mediaConstraints = {
    video: videoConstraints,
    audio: true
};

var CodecsHandler = connection.CodecsHandler;

connection.processSdp = function(sdp) {
    var codecs = 'vp8';
    
    if (codecs.length) {
        sdp = CodecsHandler.preferCodec(sdp, codecs.toLowerCase());
    }

    if (resolutions == 'HD') {
        sdp = CodecsHandler.setApplicationSpecificBandwidth(sdp, {
            audio: 128,
            video: bitrates,
            screen: bitrates
        });

        sdp = CodecsHandler.setVideoBitrates(sdp, {
            min: bitrates * 8 * 1024,
            max: bitrates * 8 * 1024,
        });
    }

    if (resolutions == 'Ultra-HD') {
        sdp = CodecsHandler.setApplicationSpecificBandwidth(sdp, {
            audio: 128,
            video: bitrates,
            screen: bitrates
        });

        sdp = CodecsHandler.setVideoBitrates(sdp, {
            min: bitrates * 8 * 1024,
            max: bitrates * 8 * 1024,
        });
    }

    return sdp;
};
// END_FIX_VIDEO_AUTO_PAUSE_ISSUES

// https://www.rtcmulticonnection.org/docs/iceServers/
// use your own TURN-server here!
connection.iceServers = [{
    'urls': [
        'stun:stun.l.google.com:19302',
        'stun:stun1.l.google.com:19302',
        'stun:stun2.l.google.com:19302',
        'stun:stun.l.google.com:19302?transport=udp',
    ]
}];

connection.videosContainer = document.getElementById('videos-container');
connection.onstream = function(event) {
    var existing = document.getElementById(event.streamid);
    if(existing && existing.parentNode) {
      existing.parentNode.removeChild(existing);
    }

    event.mediaElement.removeAttribute('src');
    event.mediaElement.removeAttribute('srcObject');
    event.mediaElement.muted = true;
    event.mediaElement.volume = 0;

    var video = document.createElement('video');

    try {
        video.setAttributeNode(document.createAttribute('autoplay'));
        video.setAttributeNode(document.createAttribute('playsinline'));
    } catch (e) {
        video.setAttribute('autoplay', true);
        video.setAttribute('playsinline', true);
    }

    if(event.type === 'local') {
      video.volume = 0;
      try {
          video.setAttributeNode(document.createAttribute('muted'));
      } catch (e) {
          video.setAttribute('muted', true);
      }
    }
    video.srcObject = event.stream;

    var width = parseInt(connection.videosContainer.clientWidth / 3) - 20;
    var mediaElement = getHTMLMediaElement(video, {
        title: event.userid,
        buttons: ['full-screen'],
        width: width,
        showOnMouseEnter: false
    });

    connection.videosContainer.appendChild(mediaElement);

    setTimeout(function() {
        mediaElement.media.play();
    }, 5000);

    mediaElement.id = event.streamid;

    // to keep room-id in cache
    localStorage.setItem(connection.socketMessageEvent, connection.sessionid);

    chkRecordConference.parentNode.style.display = 'none';

    if(chkRecordConference.checked === true) {
      btnStopRecording.style.display = 'inline-block';
      recordingStatus.style.display = 'inline-block';

      var recorder = connection.recorder;
      if(!recorder) {
        recorder = RecordRTC([event.stream], {
          type: 'video'
        });
        recorder.startRecording();
        connection.recorder = recorder;
      }
      else {
        recorder.getInternalRecorder().addStreams([event.stream]);
      }

      if(!connection.recorder.streams) {
        connection.recorder.streams = [];
      }

      connection.recorder.streams.push(event.stream);
      recordingStatus.innerHTML = 'Recording ' + connection.recorder.streams.length + ' streams';
    }

    if(event.type === 'local') {
      connection.socket.on('disconnect', function() {
        if(!connection.getAllParticipants().length) {
          location.reload();
        }
      });
    }
};

var recordingStatus = document.getElementById('recording-status');
var chkRecordConference = document.getElementById('record-entire-conference');
var btnStopRecording = document.getElementById('btn-stop-recording');
btnStopRecording.onclick = function() {
  var recorder = connection.recorder;
  if(!recorder) return alert('No recorder found.');
  recorder.stopRecording(function() {
    var blob = recorder.getBlob();
    invokeSaveAsDialog(blob);

    connection.recorder = null;
    btnStopRecording.style.display = 'none';
    recordingStatus.style.display = 'none';
    chkRecordConference.parentNode.style.display = 'inline-block';
  });
};

connection.onstreamended = function(event) {
    var mediaElement = document.getElementById(event.streamid);
    if (mediaElement) {
        mediaElement.parentNode.removeChild(mediaElement);
    }
};

connection.onMediaError = function(e) {
    if (e.message === 'Concurrent mic process limit.') {
        if (DetectRTC.audioInputDevices.length <= 1) {
            alert('Please select external microphone. Check github issue number 483.');
            return;
        }

        var secondaryMic = DetectRTC.audioInputDevices[1].deviceId;
        connection.mediaConstraints.audio = {
            deviceId: secondaryMic
        };

        connection.join(connection.sessionid);
    }
};

connection.onmessage = function(event) {
    appendChatMessage(event.data.chatMessage);
};
    
// ..................................
// ALL below scripts are redundant!!!
// ..................................

function disableInputButtons(enable) {
    document.getElementById('room-id').onkeyup();

    document.getElementById('open-or-join-room').disabled = !enable;
    document.getElementById('open-room').disabled = !enable;
    document.getElementById('join-room').disabled = !enable;
    document.getElementById('room-id').disabled = !enable;
}

// ......................................................
// ......................Handling Room-ID................
// ......................................................

function showRoomURL(roomid) {
    var roomHashURL = '#' + roomid;
    var roomQueryStringURL = '?roomid=' + roomid;

    var html = '<h2>다음 URL을 공유해서 친구들을 초대해보세요!</h2><br>';

    html += 'Hash URL: <a href="' + roomHashURL + '" target="_blank">' + roomHashURL + '</a>';
    html += '<br>';
    html += 'QueryString URL: <a href="' + roomQueryStringURL + '" target="_blank">' + roomQueryStringURL + '</a>';

    var roomURLsDiv = document.getElementById('room-urls');
    // roomURLsDiv.innerHTML = html;

//     roomURLsDiv.style.display = 'block';
}

(function() {
    var params = {},
        r = /([^&=]+)=?([^&]*)/g;

    function d(s) {
        return decodeURIComponent(s.replace(/\+/g, ' '));
    }
    var match, search = window.location.search;
    while (match = r.exec(search.substring(1)))
        params[d(match[1])] = d(match[2]);
    window.params = params;
})();

var roomid = '';
if (localStorage.getItem(connection.socketMessageEvent)) {
    roomid = localStorage.getItem(connection.socketMessageEvent);
} else {
    roomid = connection.token();
}

var txtRoomId = document.getElementById('room-id');
txtRoomId.value = roomid;
txtRoomId.onkeyup = txtRoomId.oninput = txtRoomId.onpaste = function() {
    localStorage.setItem(connection.socketMessageEvent, document.getElementById('room-id').value);
};

var hashString = location.hash.replace('#', '');
if (hashString.length && hashString.indexOf('comment-') == 0) {
    hashString = '';
}

var roomid = params.roomid;
if (!roomid && hashString.length) {
    roomid = hashString;
}

if (roomid && roomid.length) {
    document.getElementById('room-id').value = roomid;
    localStorage.setItem(connection.socketMessageEvent, roomid);

    // auto-join-room
    (function reCheckRoomPresence() {
        connection.checkPresence(roomid, function(isRoomExist) {
            if (isRoomExist) {
                connection.join(roomid);
                return;
            }

            setTimeout(reCheckRoomPresence, 5000);
        });
    })();

    disableInputButtons();
}

// detect 2G
if(navigator.connection &&
   navigator.connection.type === 'cellular' &&
   navigator.connection.downlinkMax <= 0.115) {
  alert('2G is not supported. Please use a better internet service.');
}
</script>

  <script src="https://www.webrtc-experiment.com/common.js"></script>
</body>
</html>
